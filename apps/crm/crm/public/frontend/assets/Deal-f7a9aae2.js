import{_ as Ee,a as Oe}from"./Resizer-90c7afcc.js";import{_ as Ne}from"./FadedScrollableDiv-3bd2f113.js";import{u as Ue,_ as Be,a as qe,b as Pe,A as re,S as je,L as Fe,c as Le}from"./useActiveTabManager-5bcbed2e.js";import{E as We}from"./MultiSelectEmailInput-5f9a8434.js";import{E as ie}from"./Email2Icon-49565498.js";import{C as Ge}from"./CommentIcon-aa645985.js";import{D as He}from"./DetailsIcon-5fbd1b96.js";import{P as G}from"./PhoneIcon-cf282ece.js";import{T as Je}from"./TaskIcon-95e40b66.js";import{N as Ke}from"./NoteModal-ef63f4f5.js";import{W as Qe}from"./WhatsAppIcon-88b15828.js";import{I as Xe}from"./IndicatorIcon-81343f13.js";import{L as Ye}from"./LinkIcon-62b1d974.js";import{A as Ze}from"./ArrowUpRightIcon-8e3aac11.js";import{S as ea,g as aa,a as ta}from"./view-4ccef3d8.js";import{_ as oa}from"./LayoutHeader-bf851e4e.js";import{_ as sa}from"./OrganizationModal-f2625186.js";import{C as na}from"./ContactModal-44664e22.js";import{c as la,_ as ra,w as ia}from"./DragVerticalIcon-56a1fcba.js";import{u as da,_ as ca,b as ma}from"./modals-6b779b18.js";import{_ as de}from"./CustomActions-cc223af8.js";import{g as ua,b as _a,s as pa,d as fa,a as ce,o as va}from"./index-1be1092b.js";import{g as ga}from"./settings-efea4d57.js";import{s as ya}from"./statuses-2b43883f.js";import{l as h,z as M,G as _,E as S,a as ba,o as ha,j as H,A as Ca,c as b,u as t,g as v,w as r,p as u,b as o,H as J,F as me,h as xa,B as ka,e as K,f as d,n as Q,d as c,t as k,_ as z,r as wa,D as ue,x as Ia,I as Da}from"./index-77a1adb3.js";import{_ as za}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-c9c1b9c8.js";import{_ as _e}from"./Dropdown.vue_vue_type_script_setup_true_lang-20f66514.js";import{u as Va}from"./helpCenter-caf03f7d.js";import"./CalendarIcon-f8132aad.js";import"./CallLogModal-0a4bfef6.js";import"./ContactsIcon-4e391f66.js";import"./LeadsIcon-788f061a.js";import"./DealsIcon-b1eef88d.js";import"./TaskModal-f9c99550.js";import"./FieldLayout-9051362d.js";import"./MultipleAvatar-812974f4.js";import"./IconPicker-32bf6d73.js";import"./Popover-23375de3.js";import"./FileUploader-1509b35b.js";import"./EmailTemplateModal-8d3b6520.js";import"./AssignmentModal-615be241.js";const $a={key:1,class:"flex h-full overflow-hidden"},Aa={class:"flex items-center justify-start gap-5 border-b p-5"},Ma={class:"group relative size-12"},Sa={class:"flex flex-col gap-2.5 truncate text-ink-gray-9"},Ra={class:"truncate text-2xl font-medium"},Ta={class:"flex gap-1.5"},Ea={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Oa={key:0,class:"pr-2"},Na={key:0,class:"contacts-area"},Ua={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-ink-gray-4"},Ba={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-ink-gray-7"},qa=["onClick"],Pa={class:"truncate"},ja={class:"flex items-center"},Fa={class:"flex flex-col gap-1.5 text-base text-ink-gray-8"},La={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Wa={class:"flex items-center gap-3 p-1 py-1.5"},Ga={key:0,class:"mx-2 h-px border-t border-outline-gray-modals"},Ha={key:2,class:"flex h-20 items-center justify-center text-base text-ink-gray-5"},Et={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(pe){const{brand:fe}=ga(),{$dialog:ve,$socket:B,makeCall:ge}=ua(),{statusOptions:ye,getDealStatus:be}=ya(),{doctypeMeta:he}=_a("CRM Deal"),{updateOnboardingStep:Ce,isOnboardingStepsCompleted:xe}=Va("frappecrm"),w=xa(),V=ka(),g=pe,R=h(""),q=h(""),s=M({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:g.dealId},cache:["deal",g.dealId],onSuccess:e=>{R.value="",q.value="",e.organization&&($.update({params:{doctype:"CRM Organization",name:e.organization}}),$.fetch()),pa(s,{doc:e,$dialog:ve,$socket:B,router:V,toast:_,updateField:L,createToast:_.create,deleteDoc:Me,resource:{deal:s,dealContacts:p,sections:I},call:S})},onError:e=>{var a,n;(a=e.messages)!=null&&a[0]?(R.value=__("Not permitted"),q.value=__((n=e.messages)==null?void 0:n[0])):V.push({name:"Deals"})}}),$=M({url:"frappe.client.get",onSuccess:e=>s.data._organizationObj=e});ba(()=>{if(B.on("crm_customer_created",()=>{_.success(__("Customer created successfully"))}),s.data){$.data=s.data._organizationObj;return}s.fetch()}),ha(()=>{B.off("crm_customer_created")});const P=h(!1),T=h(!1),j=h(!1),X=h({});function ke(e,a,n){a=Array.isArray(e)?"":a,!we(e,a)&&M({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:g.dealId,fieldname:e,value:a},auto:!0,onSuccess:()=>{s.reload(),P.value=!0,_.success(__("Deal updated")),n==null||n()},onError:i=>{var D;_.error(__("Error updating deal: {0}",[(D=i.messages)==null?void 0:D[0]]))}})}function we(e,a){var i;let n=s.data.fields_meta||{};return(i=n[e])!=null&&i.reqd&&!a?(_.error(__("{0} is a required field",[n[e].label])),!0):!1}const Ie=H(()=>{let e=[{label:__("Deals"),route:{name:"Deals"}}];if(w.query.view||w.query.viewType){let a=aa(w.query.view,w.query.viewType,"CRM Deal");a&&e.push({label:__(a.label),icon:a.icon,route:{name:"Deals",params:{viewType:w.query.viewType},query:{view:w.query.view}}})}return e.push({label:E.value,route:{name:"Deal",params:{dealId:s.data.name}}}),e}),E=H(()=>{var a,n;let e=((a=he["CRM Deal"])==null?void 0:a.title_field)||"name";return((n=s.data)==null?void 0:n[e])||g.dealId});Ca(()=>({title:E.value,icon:fe.favicon}));const O=H(()=>[{name:"Activity",label:__("Activity"),icon:Le},{name:"Emails",label:__("Emails"),icon:We},{name:"Comments",label:__("Comments"),icon:Ge},{name:"Data",label:__("Data"),icon:He},{name:"Calls",label:__("Calls"),icon:G},{name:"Tasks",label:__("Tasks"),icon:Je},{name:"Notes",label:__("Notes"),icon:Ke},{name:"Attachments",label:__("Attachments"),icon:re},{name:"WhatsApp",label:__("WhatsApp"),icon:Qe,condition:()=>ia.value}].filter(a=>a.condition?a.condition():!0)),{tabIndex:C}=Ue(O,"lastDealTab"),I=M({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_sidepanel_sections",cache:["sidePanelSections","CRM Deal"],params:{doctype:"CRM Deal"},transform:e=>De(e)});I.data||I.fetch();function De(e){return e.forEach(a=>{a.name!="contacts_section"&&a.columns[0].fields.forEach(n=>{n.fieldname=="organization"&&(n.create=(i,D)=>{X.value.organization_name=i,T.value=!0,D()},n.link=i=>V.push({name:"Organization",params:{organizationId:i}}))})}),e}const N=h(!1),Y=h({});function ze(e){let a=[{label:__("Remove"),icon:"trash-2",onClick:()=>Ve(e.name)}];return e.is_primary||a.push({label:__("Set as Primary Contact"),icon:Ia(ta,{class:"h-4 w-4"}),onClick:()=>$e(e.name)}),a}async function F(e){var n;if((n=p.data)!=null&&n.find(i=>i.name===e)){_.error(__("Contact already added"));return}await S("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:g.dealId,contact:e})&&(p.reload(),_.success(__("Contact added")))}async function Ve(e){await S("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:g.dealId,contact:e})&&(p.reload(),_.success(__("Contact removed")))}async function $e(e){await S("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:g.dealId,contact:e})&&(p.reload(),_.success(__("Primary contact set")))}const p=M({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:g.dealId},cache:["deal_contacts",g.dealId],transform:e=>(e.forEach(a=>{a.opened=!1}),e)});p.data||p.fetch();function Ae(){var n;let e=(n=p.data)==null?void 0:n.find(i=>i.is_primary),a=e.mobile_no||null;if(!e){_.error(__("No primary contact set"));return}if(!a){_.error(__("No mobile number set"));return}ge(a)}function L(e,a,n){e=="status"&&!xe.value&&Ce("change_deal_status"),ke(e,a,()=>{s.data[e]=a,n==null||n()})}async function Me(e){await S("frappe.client.delete",{doctype:"CRM Deal",name:e}),V.push({name:"Deals"})}const U=h(null);function Se(){let e=O.value[C.value];["Emails","Comments","Activities"].includes(e.name)||U.value.changeTabTo("emails"),Da(()=>U.value.emailBox.show=!0)}const{assignees:W,document:x,triggerOnChange:Re}=da("CRM Deal",g.dealId);function Z(e){e!=null&&e.hasOwnProperty("deal_owner")&&W.reload()}return(e,a)=>{var ee;const n=K("FeatherIcon"),i=K("Button"),D=K("Badge");return d(),b(me,null,[t(s).data?(d(),v(oa,{key:0},{"left-header":r(()=>[o(t(za),{items:Ie.value},{prefix:r(({item:l})=>[l.icon?(d(),v(Ne,{key:0,icon:l.icon,class:"mr-2 h-4"},null,8,["icon"])):u("",!0)]),_:1},8,["items"])]),"right-header":r(()=>{var l,m;return[(l=t(s).data._customActions)!=null&&l.length?(d(),v(de,{key:0,actions:t(s).data._customActions},null,8,["actions"])):u("",!0),(m=t(x).actions)!=null&&m.length?(d(),v(de,{key:1,actions:t(x).actions},null,8,["actions"])):u("",!0),o(qe,{modelValue:t(W).data,"onUpdate:modelValue":a[0]||(a[0]=f=>t(W).data=f),data:t(x).doc,doctype:"CRM Deal"},null,8,["modelValue","data"]),t(x).doc?(d(),v(t(_e),{key:2,options:t(ye)("deal",t(x),t(s).data._customStatuses,t(Re))},{default:r(({open:f})=>[o(i,{label:t(x).doc.status},{prefix:r(()=>[o(Xe,{class:Q(t(be)(t(x).doc.status).color)},null,8,["class"])]),suffix:r(()=>[o(n,{name:f?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label"])]),_:1},8,["options"])):u("",!0)]}),_:1})):u("",!0),t(s).data?(d(),b("div",$a,[o(t(ca),{as:"div",modelValue:t(C),"onUpdate:modelValue":a[4]||(a[4]=l=>J(C)?C.value=l:null),tabs:O.value},{"tab-panel":r(()=>[o(Pe,{ref_key:"activities",ref:U,doctype:"CRM Deal",tabs:O.value,reload:P.value,"onUpdate:reload":a[1]||(a[1]=l=>P.value=l),tabIndex:t(C),"onUpdate:tabIndex":a[2]||(a[2]=l=>J(C)?C.value=l:null),modelValue:t(s),"onUpdate:modelValue":a[3]||(a[3]=l=>J(s)?s.value=l:null),onAfterSave:Z},null,8,["tabs","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),o(Ee,{side:"right",class:"flex flex-col justify-between border-l"},{default:r(()=>{var l;return[c("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium text-ink-gray-9",onClick:a[5]||(a[5]=m=>t(fa)(t(s).data.name))},k(e.__(t(s).data.name)),1),c("div",Aa,[o(t(z),{text:e.__("Organization logo")},{default:r(()=>{var m;return[c("div",Ma,[o(t(ce),{size:"3xl",class:"size-12",label:E.value,image:(m=t($).data)==null?void 0:m.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),c("div",Sa,[o(t(z),{text:((l=t($).data)==null?void 0:l.name)||e.__("Set an organization")},{default:r(()=>[c("div",Ra,k(E.value),1)]),_:1},8,["text"]),c("div",Ta,[t(la)?(d(),v(t(z),{key:0,text:e.__("Make a call")},{default:r(()=>[c("div",null,[o(i,{class:"h-7 w-7",onClick:Ae},{icon:r(()=>[o(G)]),_:1})])]),_:1},8,["text"])):u("",!0),o(t(z),{text:e.__("Send an email")},{default:r(()=>[c("div",null,[o(i,{class:"h-7 w-7",onClick:a[6]||(a[6]=m=>t(s).data.email?Se():t(_).error(e.__("No email set")))},{icon:r(()=>[o(ie)]),_:1})])]),_:1},8,["text"]),o(t(z),{text:e.__("Go to website")},{default:r(()=>[c("div",null,[o(i,{class:"h-7 w-7",onClick:a[7]||(a[7]=m=>t(s).data.website?t(va)(t(s).data.website):t(_).error(e.__("No website set")))},{icon:r(()=>[o(Ye)]),_:1})])]),_:1},8,["text"]),o(t(z),{text:e.__("Attach a file")},{default:r(()=>[c("div",null,[o(i,{class:"size-7",onClick:a[8]||(a[8]=m=>j.value=!0)},{icon:r(()=>[o(re)]),_:1})])]),_:1},8,["text"])])])]),t(s).data.sla_status?(d(),v(je,{key:0,modelValue:t(s).data,"onUpdate:modelValue":a[9]||(a[9]=m=>t(s).data=m),onUpdateField:L},null,8,["modelValue"])):u("",!0),t(I).data?(d(),b("div",Ea,[o(ea,{sections:t(I).data,addContact:F,doctype:"CRM Deal",docname:t(s).data.name,onReload:t(I).reload,onAfterFieldChange:Z},{actions:r(({section:m})=>[m.name=="contacts_section"?(d(),b("div",Oa,[o(ra,{value:"",doctype:"Contact",onChange:a[10]||(a[10]=f=>F(f)),onCreate:(f,A)=>{Y.value={first_name:f,company_name:t(s).data.organization},N.value=!0,A()}},{target:r(({togglePopover:f})=>[o(i,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:A=>f()},null,8,["onClick"])]),_:1},8,["onCreate"])])):u("",!0)]),default:r(({section:m})=>{var f,A,ae,te,oe;return[m.name=="contacts_section"?(d(),b("div",Na,[(f=t(p))!=null&&f.loading&&((ae=(A=t(p))==null?void 0:A.data)==null?void 0:ae.length)==0?(d(),b("div",Ua,[o(Fe,{class:"h-4 w-4"}),c("span",null,k(e.__("Loading...")),1)])):(oe=(te=t(p))==null?void 0:te.data)!=null&&oe.length?(d(!0),b(me,{key:1},wa(t(p).data,(y,se)=>(d(),b("div",{key:y.name},[c("div",{class:Q(["px-2 pb-2.5",[se==0?"pt-5":"pt-2.5"]])},[o(ma,{opened:y.opened},{header:r(({opened:Te,toggle:ne})=>[c("div",Ba,[c("div",{class:"flex h-7 items-center gap-2 truncate",onClick:le=>ne()},[o(t(ce),{label:y.full_name,image:y.image,size:"md"},null,8,["label","image"]),c("div",Pa,k(y.full_name),1),y.is_primary?(d(),v(D,{key:0,class:"ml-2",variant:"outline",label:e.__("Primary"),theme:"green"},null,8,["label"])):u("",!0)],8,qa),c("div",ja,[o(t(_e),{options:ze(y)},{default:r(()=>[o(i,{icon:"more-horizontal",class:"text-ink-gray-5",variant:"ghost"})]),_:2},1032,["options"]),o(i,{variant:"ghost",onClick:le=>t(V).push({name:"Contact",params:{contactId:y.name}})},{icon:r(()=>[o(Ze,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),o(i,{variant:"ghost",onClick:le=>ne()},{icon:r(()=>[o(n,{name:"chevron-right",class:Q(["h-4 w-4 text-ink-gray-9 transition-all duration-300 ease-in-out",{"rotate-90":Te}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:r(()=>[c("div",Fa,[c("div",La,[o(ie,{class:"h-4 w-4"}),ue(" "+k(y.email),1)]),c("div",Wa,[o(G,{class:"h-4 w-4"}),ue(" "+k(y.mobile_no),1)])])]),_:2},1032,["opened"])],2),se!=t(p).data.length-1?(d(),b("div",Ga)):u("",!0)]))),128)):(d(),b("div",Ha,k(e.__("No contacts added")),1))])):u("",!0)]}),_:1},8,["sections","docname","onReload"])])):u("",!0)]}),_:1})])):R.value?(d(),v(Oe,{key:2,errorTitle:R.value,errorMessage:q.value},null,8,["errorTitle","errorMessage"])):u("",!0),T.value?(d(),v(sa,{key:3,modelValue:T.value,"onUpdate:modelValue":a[11]||(a[11]=l=>T.value=l),data:X.value,options:{redirect:!1,afterInsert:l=>L("organization",l.name)}},null,8,["modelValue","data","options"])):u("",!0),N.value?(d(),v(na,{key:4,modelValue:N.value,"onUpdate:modelValue":a[12]||(a[12]=l=>N.value=l),contact:Y.value,options:{redirect:!1,afterInsert:l=>F(l.name)}},null,8,["modelValue","contact","options"])):u("",!0),(ee=t(s).data)!=null&&ee.name?(d(),v(Be,{key:5,modelValue:j.value,"onUpdate:modelValue":a[13]||(a[13]=l=>j.value=l),doctype:"CRM Deal",docname:t(s).data.name,onAfter:a[14]||(a[14]=()=>{var l,m;(m=(l=U.value)==null?void 0:l.all_activities)==null||m.reload(),e.changeTabTo("attachments")})},null,8,["modelValue","docname"])):u("",!0)],64)}}};export{Et as default};
//# sourceMappingURL=Deal-f7a9aae2.js.map
