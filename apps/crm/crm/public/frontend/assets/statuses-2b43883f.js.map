{"version":3,"file":"statuses-2b43883f.js","sources":["../../../../frontend/src/stores/statuses.js"],"sourcesContent":["import IndicatorIcon from '@/components/Icons/IndicatorIcon.vue'\nimport { capture } from '@/telemetry'\nimport { parseColor } from '@/utils'\nimport { defineStore } from 'pinia'\nimport { createListResource } from 'frappe-ui'\nimport { reactive, h } from 'vue'\n\nexport const statusesStore = defineStore('crm-statuses', () => {\n  let leadStatusesByName = reactive({})\n  let dealStatusesByName = reactive({})\n  let communicationStatusesByName = reactive({})\n\n  const leadStatuses = createListResource({\n    doctype: 'CRM Lead Status',\n    fields: ['name', 'color', 'position'],\n    orderBy: 'position asc',\n    cache: 'lead-statuses',\n    initialData: [],\n    auto: true,\n    transform(statuses) {\n      for (let status of statuses) {\n        status.color = parseColor(status.color)\n        leadStatusesByName[status.name] = status\n      }\n      return statuses\n    },\n  })\n\n  const dealStatuses = createListResource({\n    doctype: 'CRM Deal Status',\n    fields: ['name', 'color', 'position'],\n    orderBy: 'position asc',\n    cache: 'deal-statuses',\n    initialData: [],\n    auto: true,\n    transform(statuses) {\n      for (let status of statuses) {\n        status.color = parseColor(status.color)\n        dealStatusesByName[status.name] = status\n      }\n      return statuses\n    },\n  })\n\n  const communicationStatuses = createListResource({\n    doctype: 'CRM Communication Status',\n    fields: ['name'],\n    cache: 'communication-statuses',\n    initialData: [],\n    auto: true,\n    transform(statuses) {\n      for (let status of statuses) {\n        communicationStatusesByName[status.name] = status\n      }\n      return statuses\n    },\n  })\n\n  function getLeadStatus(name) {\n    if (!name) {\n      name = leadStatuses.data[0].name\n    }\n    return leadStatusesByName[name]\n  }\n\n  function getDealStatus(name) {\n    if (!name) {\n      name = dealStatuses.data[0].name\n    }\n    return dealStatusesByName[name]\n  }\n\n  function getCommunicationStatus(name) {\n    if (!name) {\n      name = communicationStatuses.data[0].name\n    }\n    return communicationStatuses[name]\n  }\n\n  function statusOptions(\n    doctype,\n    document,\n    statuses = [],\n    triggerOnChange = null,\n  ) {\n    let statusesByName =\n      doctype == 'deal' ? dealStatusesByName : leadStatusesByName\n\n    if (document?.statuses?.length) {\n      statuses = document.statuses\n    }\n\n    if (statuses?.length) {\n      statusesByName = statuses.reduce((acc, status) => {\n        acc[status] = statusesByName[status]\n        return acc\n      }, {})\n    }\n\n    let options = []\n    for (const status in statusesByName) {\n      options.push({\n        label: statusesByName[status]?.name,\n        value: statusesByName[status]?.name,\n        icon: () => h(IndicatorIcon, { class: statusesByName[status]?.color }),\n        onClick: async () => {\n          capture('status_changed', { doctype, status })\n          if (document) {\n            await triggerOnChange?.('status', statusesByName[status]?.name)\n            document.save.submit()\n          }\n        },\n      })\n    }\n    return options\n  }\n\n  return {\n    leadStatuses,\n    dealStatuses,\n    communicationStatuses,\n    getLeadStatus,\n    getDealStatus,\n    getCommunicationStatus,\n    statusOptions,\n  }\n})\n"],"names":["statusesStore","defineStore","leadStatusesByName","reactive","dealStatusesByName","communicationStatusesByName","leadStatuses","createListResource","statuses","status","parseColor","dealStatuses","communicationStatuses","getLeadStatus","name","getDealStatus","getCommunicationStatus","statusOptions","doctype","document","triggerOnChange","statusesByName","_a","acc","options","_b","_c","h","IndicatorIcon","capture"],"mappings":"6JAOY,MAACA,EAAgBC,EAAY,eAAgB,IAAM,CAC7D,IAAIC,EAAqBC,EAAS,EAAE,EAChCC,EAAqBD,EAAS,EAAE,EAChCE,EAA8BF,EAAS,EAAE,EAE7C,MAAMG,EAAeC,EAAmB,CACtC,QAAS,kBACT,OAAQ,CAAC,OAAQ,QAAS,UAAU,EACpC,QAAS,eACT,MAAO,gBACP,YAAa,CAAE,EACf,KAAM,GACN,UAAUC,EAAU,CAClB,QAASC,KAAUD,EACjBC,EAAO,MAAQC,EAAWD,EAAO,KAAK,EACtCP,EAAmBO,EAAO,IAAI,EAAIA,EAEpC,OAAOD,CACR,CACL,CAAG,EAEKG,EAAeJ,EAAmB,CACtC,QAAS,kBACT,OAAQ,CAAC,OAAQ,QAAS,UAAU,EACpC,QAAS,eACT,MAAO,gBACP,YAAa,CAAE,EACf,KAAM,GACN,UAAUC,EAAU,CAClB,QAASC,KAAUD,EACjBC,EAAO,MAAQC,EAAWD,EAAO,KAAK,EACtCL,EAAmBK,EAAO,IAAI,EAAIA,EAEpC,OAAOD,CACR,CACL,CAAG,EAEKI,EAAwBL,EAAmB,CAC/C,QAAS,2BACT,OAAQ,CAAC,MAAM,EACf,MAAO,yBACP,YAAa,CAAE,EACf,KAAM,GACN,UAAUC,EAAU,CAClB,QAASC,KAAUD,EACjBH,EAA4BI,EAAO,IAAI,EAAIA,EAE7C,OAAOD,CACR,CACL,CAAG,EAED,SAASK,EAAcC,EAAM,CAC3B,OAAKA,IACHA,EAAOR,EAAa,KAAK,CAAC,EAAE,MAEvBJ,EAAmBY,CAAI,CAC/B,CAED,SAASC,EAAcD,EAAM,CAC3B,OAAKA,IACHA,EAAOH,EAAa,KAAK,CAAC,EAAE,MAEvBP,EAAmBU,CAAI,CAC/B,CAED,SAASE,EAAuBF,EAAM,CACpC,OAAKA,IACHA,EAAOF,EAAsB,KAAK,CAAC,EAAE,MAEhCA,EAAsBE,CAAI,CAClC,CAED,SAASG,EACPC,EACAC,EACAX,EAAW,CAAE,EACbY,EAAkB,KAClB,WACA,IAAIC,EACFH,GAAW,OAASd,EAAqBF,GAEvCoB,EAAAH,GAAA,YAAAA,EAAU,WAAV,MAAAG,EAAoB,SACtBd,EAAWW,EAAS,UAGlBX,GAAA,MAAAA,EAAU,SACZa,EAAiBb,EAAS,OAAO,CAACe,EAAKd,KACrCc,EAAId,CAAM,EAAIY,EAAeZ,CAAM,EAC5Bc,GACN,EAAE,GAGP,IAAIC,EAAU,CAAE,EAChB,UAAWf,KAAUY,EACnBG,EAAQ,KAAK,CACX,OAAOC,EAAAJ,EAAeZ,CAAM,IAArB,YAAAgB,EAAwB,KAC/B,OAAOC,EAAAL,EAAeZ,CAAM,IAArB,YAAAiB,EAAwB,KAC/B,KAAM,IAAA,OAAM,OAAAC,EAAEC,EAAe,CAAE,OAAON,EAAAD,EAAeZ,CAAM,IAArB,YAAAa,EAAwB,MAAO,GACrE,QAAS,SAAY,OACnBO,EAAQ,iBAAkB,CAAE,QAAAX,EAAS,OAAAT,CAAM,CAAE,EACzCU,IACF,MAAMC,GAAA,YAAAA,EAAkB,UAAUE,EAAAD,EAAeZ,CAAM,IAArB,YAAAa,EAAwB,OAC1DH,EAAS,KAAK,OAAQ,EAEzB,CACT,CAAO,EAEH,OAAOK,CACR,CAED,MAAO,CACL,aAAAlB,EACA,aAAAK,EACA,sBAAAC,EACA,cAAAC,EACA,cAAAE,EACA,uBAAAC,EACA,cAAAC,CACD,CACH,CAAC"}