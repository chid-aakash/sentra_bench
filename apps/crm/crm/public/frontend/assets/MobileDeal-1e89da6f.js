import{_ as xe}from"./FadedScrollableDiv-3bd2f113.js";import{D as Y}from"./DetailsIcon-5fbd1b96.js";import{u as we,a as Ie,S as ke,L as De,b as Ve,c as Me,A as Ae}from"./useActiveTabManager-5bcbed2e.js";import{E as Re}from"./MultiSelectEmailInput-5f9a8434.js";import{E as Se}from"./Email2Icon-49565498.js";import{C as $e}from"./CommentIcon-aa645985.js";import{P as Z}from"./PhoneIcon-cf282ece.js";import{T as ze}from"./TaskIcon-95e40b66.js";import{N as Ee}from"./NoteModal-ef63f4f5.js";import{W as Te}from"./WhatsAppIcon-88b15828.js";import{I as qe}from"./IndicatorIcon-81343f13.js";import{A as Pe}from"./ArrowUpRightIcon-8e3aac11.js";import{S as Oe,g as Ue,a as Be}from"./view-4ccef3d8.js";import{_ as Ne}from"./LayoutHeader-bf851e4e.js";import{_ as je}from"./OrganizationModal-f2625186.js";import{C as Fe}from"./ContactModal-44664e22.js";import{u as Le,d as We,e as Ge,b as He,_ as Je}from"./modals-6b779b18.js";import{_ as Ke,i as Qe,c as Xe,w as Ye}from"./DragVerticalIcon-56a1fcba.js";import{_ as ee}from"./CustomActions-cc223af8.js";import{g as Ze,b as ea,s as aa,a as ta}from"./index-1be1092b.js";import{g as oa}from"./settings-efea4d57.js";import{s as sa}from"./statuses-2b43883f.js";import{z as D,G as g,E as V,a as na,l as M,j as P,A as la,c as u,u as t,g as y,w as c,p as d,b as l,d as p,H as O,F as ae,h as ia,B as ra,e as U,f as i,n as B,t as A,r as ca,D as te,x as da}from"./index-77a1adb3.js";import{_ as ma}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-c9c1b9c8.js";import{_ as oe}from"./Dropdown.vue_vue_type_script_setup_true_lang-20f66514.js";import"./CalendarIcon-f8132aad.js";import"./CallLogModal-0a4bfef6.js";import"./ContactsIcon-4e391f66.js";import"./LeadsIcon-788f061a.js";import"./DealsIcon-b1eef88d.js";import"./TaskModal-f9c99550.js";import"./helpCenter-caf03f7d.js";import"./FieldLayout-9051362d.js";import"./MultipleAvatar-812974f4.js";import"./IconPicker-32bf6d73.js";import"./Popover-23375de3.js";import"./FileUploader-1509b35b.js";import"./EmailTemplateModal-8d3b6520.js";import"./AssignmentModal-615be241.js";const ua={class:"relative flex h-10.5 items-center justify-between gap-2 py-2.5 pl-2"},pa={class:"absolute right-0"},_a={key:1,class:"flex h-12 items-center justify-between gap-2 border-b px-3 py-2.5"},fa={class:"flex items-center gap-2"},ya={key:2,class:"flex h-full overflow-hidden"},ga={key:0},va={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},ha={key:0,class:"pr-2"},ba={key:0,class:"contacts-area"},Ca={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-ink-gray-4"},xa={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-ink-gray-7"},wa=["onClick"],Ia={class:"truncate"},ka={class:"flex items-center"},Da={class:"flex flex-col gap-1.5 text-base text-ink-gray-8"},Va={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Ma={class:"flex items-center gap-3 p-1 py-1.5"},Aa={key:0,class:"mx-2 h-px border-t border-outline-gray-modals"},Ra={key:2,class:"flex h-20 items-center justify-center text-base text-ink-gray-5"},yt={__name:"MobileDeal",props:{dealId:{type:String,required:!0}},setup(se){const{brand:ne}=oa(),{$dialog:le,$socket:ie}=Ze(),{statusOptions:re,getDealStatus:ce}=sa(),{doctypeMeta:de}=ea("CRM Deal"),C=ia(),R=ra(),_=se,n=D({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:_.dealId},cache:["deal",_.dealId],onSuccess:e=>{e.organization&&(N.update({params:{doctype:"CRM Organization",name:e.organization}}),N.fetch()),aa(n,{doc:e,$dialog:le,$socket:ie,router:R,toast:g,updateField:T,createToast:g.create,deleteDoc:ve,resource:{deal:n,dealContacts:h,sections:I},call:V})}}),N=D({url:"frappe.client.get",onSuccess:e=>n.data._organizationObj=e});na(()=>{n.data||n.fetch()});const z=M(!1),S=M(!1),j=M({});function me(e,a,o){a=Array.isArray(e)?"":a,!ue(e,a)&&D({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:_.dealId,fieldname:e,value:a},auto:!0,onSuccess:()=>{n.reload(),z.value=!0,g.success(__("Deal updated")),o==null||o()},onError:s=>{var w;g.error(((w=s.messages)==null?void 0:w[0])||__("Error updating deal"))}})}function ue(e,a){var s;let o=n.data.fields_meta||{};return(s=o[e])!=null&&s.reqd&&!a?(g.error(__("{0} is a required field",[o[e].label])),!0):!1}const pe=P(()=>{let e=[{label:__("Deals"),route:{name:"Deals"}}];if(C.query.view||C.query.viewType){let a=Ue(C.query.view,C.query.viewType,"CRM Deal");a&&e.push({label:__(a.label),icon:a.icon,route:{name:"Deals",params:{viewType:C.query.viewType},query:{view:C.query.view}}})}return e.push({label:F.value,route:{name:"Deal",params:{dealId:n.data.name}}}),e}),F=P(()=>{var a,o;let e=((a=de["CRM Deal"])==null?void 0:a.title_field)||"name";return((o=n.data)==null?void 0:o[e])||_.dealId});la(()=>({title:F.value,icon:ne.favicon}));const E=P(()=>[{name:"Details",label:__("Details"),icon:Y,condition:()=>Qe.value},{name:"Activity",label:__("Activity"),icon:Me},{name:"Emails",label:__("Emails"),icon:Re},{name:"Comments",label:__("Comments"),icon:$e},{name:"Data",label:__("Data"),icon:Y},{name:"Calls",label:__("Calls"),icon:Z,condition:()=>Xe.value},{name:"Tasks",label:__("Tasks"),icon:ze},{name:"Notes",label:__("Notes"),icon:Ee},{name:"Attachments",label:__("Attachments"),icon:Ae},{name:"WhatsApp",label:__("WhatsApp"),icon:Te,condition:()=>Ye.value}].filter(a=>a.condition?a.condition():!0)),{tabIndex:x}=we(E,"lastDealTab"),I=D({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_sidepanel_sections",cache:["sidePanelSections","CRM Deal"],params:{doctype:"CRM Deal"},auto:!0,transform:e=>_e(e)});function _e(e){return e.forEach(a=>{a.name!="contacts_section"&&a.columns[0].fields.forEach(o=>{o.name=="organization"&&(o.create=(s,w)=>{j.value.organization_name=s,S.value=!0,w()},o.link=s=>R.push({name:"Organization",params:{organizationId:s}}))})}),e}const $=M(!1),L=M({});function fe(e){let a=[{label:__("Delete"),icon:"trash-2",onClick:()=>ye(e)}];return e.is_primary||a.push({label:__("Set as Primary Contact"),icon:da(Be,{class:"h-4 w-4"}),onClick:()=>ge(e.name)}),a}async function W(e){var o;if((o=h.data)!=null&&o.find(s=>s.name===e)){g.error(__("Contact already added"));return}await V("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:_.dealId,contact:e})&&(h.reload(),g.success(__("Contact added")))}async function ye(e){await V("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:_.dealId,contact:e})&&(h.reload(),g.success(__("Contact removed")))}async function ge(e){await V("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:_.dealId,contact:e})&&(h.reload(),g.success(__("Primary contact set")))}const h=D({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:_.dealId},cache:["deal_contacts",_.dealId],auto:!0,onSuccess:e=>{var o;let a=(o=I.data)==null?void 0:o.find(s=>s.name=="contacts_section");a&&(a.contacts=e.map(s=>({name:s.name,full_name:s.full_name,email:s.email,mobile_no:s.mobile_no,image:s.image,is_primary:s.is_primary,opened:!1})))}});function T(e,a,o){me(e,a,()=>{n.data[e]=a,o==null||o()})}async function ve(e){await V("frappe.client.delete",{doctype:"CRM Deal",name:e}),R.push({name:"Deals"})}const{assignees:q,document:b,triggerOnChange:he}=Le("CRM Deal",_.dealId);function be(e){e!=null&&e.hasOwnProperty("deal_owner")&&q.reload()}return(e,a)=>{var G,H;const o=U("FeatherIcon"),s=U("Button"),w=U("Badge");return i(),u(ae,null,[t(n).data?(i(),y(Ne,{key:0},{default:c(()=>[p("header",ua,[l(t(ma),{items:pe.value},{prefix:c(({item:r})=>[r.icon?(i(),y(xe,{key:0,icon:r.icon,class:"mr-2 h-4"},null,8,["icon"])):d("",!0)]),_:1},8,["items"]),p("div",pa,[t(b).doc?(i(),y(t(oe),{key:0,options:t(re)("deal",t(b),t(n).data._customStatuses,t(he))},{default:c(({open:r})=>[l(s,{label:t(b).doc.status},{prefix:c(()=>[l(qe,{class:B(t(ce)(t(b).doc.status).color)},null,8,["class"])]),suffix:c(()=>[l(o,{name:r?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label"])]),_:1},8,["options"])):d("",!0)])])]),_:1})):d("",!0),t(n).data?(i(),u("div",_a,[l(Ie,{modelValue:t(q).data,"onUpdate:modelValue":a[0]||(a[0]=r=>t(q).data=r),data:t(b).doc,doctype:"CRM Deal"},null,8,["modelValue","data"]),p("div",fa,[(G=t(n).data._customActions)!=null&&G.length?(i(),y(ee,{key:0,actions:t(n).data._customActions},null,8,["actions"])):d("",!0),(H=t(b).actions)!=null&&H.length?(i(),y(ee,{key:1,actions:t(b).actions},null,8,["actions"])):d("",!0)])])):d("",!0),t(n).data?(i(),u("div",ya,[l(t(Je),{as:"div",modelValue:t(x),"onUpdate:modelValue":a[6]||(a[6]=r=>O(x)?x.value=r:null),tabs:E.value,class:"overflow-auto"},{default:c(()=>[l(t(We),{class:"!px-3"}),l(t(Ge),null,{default:c(({tab:r})=>[r.name=="Details"?(i(),u("div",ga,[t(n).data.sla_status?(i(),y(ke,{key:0,modelValue:t(n).data,"onUpdate:modelValue":a[1]||(a[1]=m=>t(n).data=m),onUpdateField:T},null,8,["modelValue"])):d("",!0),t(I).data?(i(),u("div",va,[l(Oe,{sections:t(I).data,doctype:"CRM Deal",docname:t(n).data.name,onReload:t(I).reload,onAfterFieldChange:be},{actions:c(({section:m})=>[m.name=="contacts_section"?(i(),u("div",ha,[l(Ke,{value:"",doctype:"Contact",onChange:a[2]||(a[2]=v=>W(v)),onCreate:(v,k)=>{L.value={first_name:v,company_name:t(n).data.organization},$.value=!0,k()}},{target:c(({togglePopover:v})=>[l(s,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:k=>v()},null,8,["onClick"])]),_:1},8,["onCreate"])])):d("",!0)]),default:c(({section:m})=>{var v,k,J;return[m.name=="contacts_section"?(i(),u("div",ba,[(v=t(h))!=null&&v.loading&&((J=(k=t(h))==null?void 0:k.data)==null?void 0:J.length)==0?(i(),u("div",Ca,[l(De,{class:"h-4 w-4"}),p("span",null,A(e.__("Loading...")),1)])):m.contacts.length?(i(!0),u(ae,{key:1},ca(m.contacts,(f,K)=>(i(),u("div",{key:f.name},[p("div",{class:B(["px-2 pb-2.5",[K==0?"pt-5":"pt-2.5"]])},[l(He,{opened:f.opened},{header:c(({opened:Ce,toggle:Q})=>[p("div",xa,[p("div",{class:"flex h-7 items-center gap-2 truncate",onClick:X=>Q()},[l(t(ta),{label:f.full_name,image:f.image,size:"md"},null,8,["label","image"]),p("div",Ia,A(f.full_name),1),f.is_primary?(i(),y(w,{key:0,class:"ml-2",variant:"outline",label:e.__("Primary"),theme:"green"},null,8,["label"])):d("",!0)],8,wa),p("div",ka,[l(t(oe),{options:fe(f.name)},{default:c(()=>[l(s,{icon:"more-horizontal",class:"text-ink-gray-5",variant:"ghost"})]),_:2},1032,["options"]),l(s,{variant:"ghost",onClick:X=>t(R).push({name:"Contact",params:{contactId:f.name}})},{default:c(()=>[l(Pe,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),l(s,{variant:"ghost",onClick:X=>Q()},{default:c(()=>[l(o,{name:"chevron-right",class:B(["h-4 w-4 text-ink-gray-9 transition-all duration-300 ease-in-out",{"rotate-90":Ce}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:c(()=>[p("div",Da,[p("div",Va,[l(Se,{class:"h-4 w-4"}),te(" "+A(f.email),1)]),p("div",Ma,[l(Z,{class:"h-4 w-4"}),te(" "+A(f.mobile_no),1)])])]),_:2},1032,["opened"])],2),K!=m.contacts.length-1?(i(),u("div",Aa)):d("",!0)]))),128)):(i(),u("div",Ra,A(e.__("No contacts added")),1))])):d("",!0)]}),_:1},8,["sections","docname","onReload"])])):d("",!0)])):(i(),y(Ve,{key:1,doctype:"CRM Deal",tabs:E.value,reload:z.value,"onUpdate:reload":a[3]||(a[3]=m=>z.value=m),tabIndex:t(x),"onUpdate:tabIndex":a[4]||(a[4]=m=>O(x)?x.value=m:null),modelValue:t(n),"onUpdate:modelValue":a[5]||(a[5]=m=>O(n)?n.value=m:null)},null,8,["tabs","reload","tabIndex","modelValue"]))]),_:1})]),_:1},8,["modelValue","tabs"])])):d("",!0),S.value?(i(),y(je,{key:3,modelValue:S.value,"onUpdate:modelValue":a[7]||(a[7]=r=>S.value=r),data:j.value,options:{redirect:!1,afterInsert:r=>T("organization",r.name)}},null,8,["modelValue","data","options"])):d("",!0),$.value?(i(),y(Fe,{key:4,modelValue:$.value,"onUpdate:modelValue":a[8]||(a[8]=r=>$.value=r),contact:L.value,options:{redirect:!1,afterInsert:r=>W(r.name)}},null,8,["modelValue","contact","options"])):d("",!0)],64)}}};export{yt as default};
//# sourceMappingURL=MobileDeal-1e89da6f.js.map
